<aura:component description="Displays the diagram data as a SOQL statement">

    <ltng:require scripts="{!join(',', $Resource.pure, $Resource.LightningUtils)}"
                  afterScriptsLoaded="{!c.doInit}"/>

    <aura:attribute name="diagram" type="Object" access="public"
                    description="the diagram JSON object, generated by the main ERD editor and persisted using the DiagramDataService component"/>
    <aura:attribute name="soql" type="String"
                    description="the fully rendered SOQL query, derived from the diagram"/>
    <aura:attribute name="selectLists" type="String[]"
                    description="the list of select lists, one for each joined entity"/>
    <aura:attribute name="from" type="String"
                    access="public"
                    description="the entity that the SOQL query uses in its FROM clause"/>
    <aura:attribute name="entityOptions" type="List"
                    description="All of the entities that can be used as a FROM entity"/>

    <aura:attribute name="ready" type="Boolean" access="private" default="false"
                    description="true when this component has loaded from its static resource and can begin rendering"/>
    <aura:attribute name="prompt" type="String" access="private" default="FROM"
                    description="The label to the left of the FROM select"/>
    <aura:attribute name="mode" type="String" access="private" default="preview"
                    description="'preview' shows the select, 'soql' shows the raw query"/>

    <aura:handler name="change" value="{!v.diagram}" action="{!c.diagramChange}"/>
    <aura:handler name="change" value="{!v.from}" action="{!c.fromChange}"/>

    <aura:registerEvent name="fromChange" type="c:SOQLFromChangeEvent"/>

    <lightning:layout multipleRows="true">

        <aura:if isTrue="{!equals(v.mode, 'soql')}">
            <lightning:layoutItem size="12" padding="around-small">
                <div class="soql">{!v.soql}</div>
            </lightning:layoutItem>
            <lightning:layoutItem size="12" padding="around-small">
                <div class="slds-clearfix">
                    <div class="slds-float_right">
                        <lightning:buttonIcon iconName="utility:hide" size="large" variant="bare"
                                              onclick="{! c.handlePreviewClick }" alternativeText="Show SOQL Config"/>
                    </div>
                </div>
            </lightning:layoutItem>
        </aura:if>

        <aura:if isTrue="{!equals(v.mode, 'preview')}">
            <lightning:layoutItem size="12" padding="around-small">
                <ul class="preview">
                    <aura:if isTrue="{!v.from}">
                        <li>SELECT</li>
                        <aura:iteration items="{!v.selectLists}" var="sl">
                            <li>{!sl}</li>
                        </aura:iteration>
                    </aura:if>
                    <li>
                        <div class="slds-clearfix">
                            <div class="slds-float_left">{!v.prompt}</div>
                            <div class="slds-float_left from-select">
                                <lightning:select aura:id="fromSelect" name="from-select" label="" value="{!v.from}">
                                    <option value="">-- Object --</option>
                                    <aura:iteration items="{!v.entityOptions}" var="opt">
                                        <option value="{!opt.value}">{!opt.label}</option>
                                    </aura:iteration>
                                </lightning:select>
                            </div>
                            <aura:if isTrue="{!v.from}">
                                <div class="slds-float_left close-button">
                                    <lightning:buttonIcon iconName="utility:close" size="large" variant="bare"
                                                          onclick="{! c.handleClearClick }" alternativeText="Clear"/>
                                </div>
                                <div class="slds-float_right">
                                    <span aura:id="copied" class="copied-fade" style="opacity:0;">Copied!</span>
                                    <lightning:buttonIcon class="control" variant="bare"
                                                          iconName="utility:copy" size="large"
                                                          alternativeText="Copy SOQL to Clipboard"
                                                          title="Copy SOQL to Clipboard"
                                                          onclick="{! c.handleCopyClick }"/>
                                    <lightning:buttonIcon iconName="utility:preview" size="large" variant="bare"
                                                          onclick="{! c.handleSOQLClick }" alternativeText="Show SOQL"/>
                                </div>
                            </aura:if>
                        </div>
                    </li>
                </ul>
            </lightning:layoutItem>
        </aura:if>

    </lightning:layout>

</aura:component>
